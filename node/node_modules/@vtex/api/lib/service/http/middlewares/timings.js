"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const status_1 = require("../../../utils/status");
const time_1 = require("../../../utils/time");
const unhandled_1 = require("../../../utils/unhandled");
const log = ({ vtex: { account, workspace, route: { id } }, path, method, status }, millis) => `${new Date().toISOString()}\t${account}/${workspace}:${id}\t${status}\t${method}\t${path}\t${millis}ms`;
async function timings(ctx, next) {
    const start = process.hrtime();
    unhandled_1.updateLastLogger(ctx.clients.logger);
    // Errors will be caught by the next middleware so we don't have to catch.
    await next();
    const { status, vtex: { route: { id } } } = ctx;
    const end = process.hrtime(start);
    const millis = time_1.hrToMillis(end);
    metrics.batch(`http-handler-${status_1.statusLabel(status)}-${id}`, end, { [status]: 1 });
    console.log(log(ctx, millis));
}
exports.timings = timings;
